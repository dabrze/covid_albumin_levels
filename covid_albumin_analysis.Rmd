---
title: "Analysis of albumin and glucose levels in patients from Tongji Hospital, Wuhan, China"
author: "Dariusz Brzezinski"
date: "`r Sys.Date()`"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = F)

library(readxl)
library(Hmisc)
library(ggplot2)
library(ggforce)
library(dplyr)
library(zoo)
library(ggpubr)
library(lme4)
```

```{r functions}
DPI=600
PLOT_SIZE=5
FONT_SIZE=18
PLOT_UNITS="in"
DEATH_COLOR <- "#EE6677"
SURVIVED_COLOR <- "#4477AA"
NORMAL_RANGE_COLOR <- "#000000"
OUTCOME_PALETTE <- c(DEATH_COLOR, SURVIVED_COLOR)

read_data <- function(file) {
  df <- read_excel(file)
  df$PATIENT_ID <- na.locf(df$PATIENT_ID)
  df <- na.locf(df)
  
  for (id in unique(df$PATIENT_ID)) {
    df[df$PATIENT_ID == id,"First_RE_DATE"] <- df[df$PATIENT_ID == id, "RE_DATE"][[1]][1]
  }
  
  df_all_samples <- df %>%
    mutate(gender = replace(gender, gender == 1, "Male"), 
           gender = replace(gender, gender == 2, "Female"),
           gender = factor(gender, levels = c("Male", "Female")),
           OutcomeFactor = replace(outcome, outcome == 0, "Survived"), 
           OutcomeFactor = replace(OutcomeFactor, OutcomeFactor == 1, "Died"),
           OutcomeNumber = replace(OutcomeFactor, OutcomeFactor == "Survived", 1), 
           OutcomeNumber = replace(OutcomeNumber, OutcomeFactor == "Died", 0),
           OutcomeNumber = as.numeric(OutcomeNumber),
           TimeSinceSubmission = as.numeric(difftime(RE_DATE, First_RE_DATE), units="days"))
  
  df_all_samples
}

get_last_samples <- function(df_all_samples) {
  df <- df_all_samples %>%
    group_by(PATIENT_ID) %>% 
    summarise(albumin=last(albumin), OutcomeFactor=last(OutcomeFactor), OutcomeNumber=last(OutcomeNumber),
              glucose=last(glucose), gender=last(gender), age=last(age), n=n(),
              TimeSinceSubmission=last(TimeSinceSubmission))
  
  df
}

get_first_samples <- function(df_all_samples) {
  df <- df_all_samples %>%
    group_by(PATIENT_ID) %>% 
    summarise(albumin=first(albumin), OutcomeFactor=first(OutcomeFactor), OutcomeNumber=first(OutcomeNumber),
              glucose=first(glucose), gender=first(gender), age=first(age), n=n(),
              TimeSinceSubmission=first(TimeSinceSubmission))
  
  df
}

save_plot <- function(p, name, width=PLOT_SIZE, height=PLOT_SIZE) {
  ggsave(paste0("plots/", name, ".svg"), p, width=width, height=height, units=PLOT_UNITS, dpi=DPI)
  ggsave(paste0("plots/", name, ".png"), p, width=width, height=height, units=PLOT_UNITS, dpi=DPI)
}
```

This notebook presents the plot scripts and statistical analysis presented in the by Shabalin *et al.*

# Data characteristics

```{r}
df_all <- read_data("data/time_series_375_prerpocess_en.xlsx")
df_first <- get_first_samples(df_all)
df_last <- get_last_samples(df_all)

tapply(df_last[df_last$gender == "Female", ]$gender,df_last[df_last$gender == "Female", ]$OutcomeFactor, length)
```

# Albumin levels

## Distributions and normality tests

```{r}
draw_albumin_sina_plot <-function(df) {
  p <- ggplot(df, aes(x=OutcomeFactor, y=albumin, color=OutcomeFactor)) + 
  geom_hline(aes(yintercept=35), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_hline(aes(yintercept=55), colour=NORMAL_RANGE_COLOR, linetype="dashed") + 
    
  geom_sina(seed=21) + 
  stat_summary(fun.data = "mean_sdl",  fun.args = list(mult = 1), 
               geom = "pointrange", color = "black") +
  theme_classic() + 
  theme(legend.position = "none",
        strip.background = element_blank(),
        text = element_text(size=FONT_SIZE), 
        axis.text = element_text(colour = "black", size=FONT_SIZE), 
        axis.title.y = element_text(margin = margin(t = 0, r = 8, b = 0, l = 0))) + 
  xlab("") + 
  ylab ("Patient's albumin level (g/L)") +
  labs(color = "Outcome") + 
  ylim(13, 56) +
  scale_color_manual(values=OUTCOME_PALETTE)
  
  p
}

draw_qq_plot <- function(df, column) {
  ggqqplot(df_last, x=column, color="OutcomeFactor", palette = c("#EE6677", "#4477AA")) + 
  labs(color = "Outcome", fill = "Outcome") + 
  theme(legend.position = c(0.88, 0.18), 
        axis.text = element_text(colour = "black", size=18), 
        text = element_text(size=18)) + xlab("Theoretical quantiles") + ylab("Sample quantiles")
}
```


```{r}
albumin_sina_plot <- draw_albumin_sina_plot(df_last)
save_plot(albumin_sina_plot, "albumin_sina_plot")
albumin_sina_plot
```


```{r}
albumin_qq_plot <- draw_qq_plot(df_last, "albumin")
save_plot(albumin_qq_plot, "albumin_qq_plot")
albumin_qq_plot
```


```{r}
shapiro.test(df_last[df_last$OutcomeFactor=="Died",]$albumin)
shapiro.test(df_last[df_last$OutcomeFactor=="Survived",]$albumin)
t.test(df_last[df_last$OutcomeFactor=="Died",]$albumin, df_last[df_last$OutcomeFactor=="Survived",]$albumin)

t.test(df_last[df_last$OutcomeFactor=="Died" & df_last$gender=="Male",]$albumin, df_last[df_last$OutcomeFactor=="Survived" & df_last$gender=="Male",]$albumin)
t.test(df_last[df_last$OutcomeFactor=="Died" & df_last$gender=="Female",]$albumin, df_last[df_last$OutcomeFactor=="Survived" & df_last$gender=="Female",]$albumin)
```


## Gender

```{r}
albumin_gender_plot <- albumin_sina_plot + facet_grid(cols = vars(gender))
save_plot(albumin_gender_plot + theme(strip.text.x = element_blank()), "albumin_gender_plot")
albumin_gender_plot
```

## Time series and trends

```{r}
draw_albumin_time_series_plot <- function(df_all, aDeath, bDeath, aSurvived, bSurvived) {
  p <- ggplot(df_all, aes(x=TimeSinceSubmission, y=albumin, color=OutcomeFactor)) + 
    geom_hline(aes(yintercept=35), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
    geom_hline(aes(yintercept=55), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
    geom_line(mapping=aes(group=PATIENT_ID), alpha=0.35) +
    geom_segment(aes(x=0, xend=22, y=bDeath + aDeath,
                     yend = bDeath + aDeath*22),
                 color=DEATH_COLOR, size=1.25) +
    geom_segment(aes(x=0, xend=22, y=bSurvived + aSurvived,
                     yend = bSurvived + aSurvived*22),
                 color=SURVIVED_COLOR, size=1.25) +
    theme_classic() + 
    theme(legend.position = c(0.88, 0.18),
          text = element_text(size=FONT_SIZE), 
          axis.text = element_text(colour = "black", size=FONT_SIZE), 
          axis.text.y = element_blank()) +
    xlab("Days since admission") + 
    ylab ("") +
    labs(color = "Outcome") + 
    ylim(13, 56) +
    scale_color_manual(values=OUTCOME_PALETTE)
  

  p
}
```

```{r}
d <- rbind(df_first, df_last)

fits <- lmList(albumin ~ TimeSinceSubmission | PATIENT_ID, data=d)
coefs <- coef(fits)
coefs <- cbind(coefs, df_last)

aDeath <- median(coefs[coefs$OutcomeFactor == "Died", "TimeSinceSubmission"], na.rm=T)
bDeath <- median(coefs[coefs$OutcomeFactor == "Died", "(Intercept)"], na.rm=T)
aSurvived <- median(coefs[coefs$OutcomeFactor == "Survived", "TimeSinceSubmission"], na.rm=T)
bSurvived <- median(coefs[coefs$OutcomeFactor == "Survived", "(Intercept)"], na.rm=T)

print(paste("Died = ", round(aDeath, 2), "Time + ", bDeath))
print(paste("Survived = ", round(aSurvived, 2), "Time + ", bSurvived))
```

```{r}
IQR(coefs[coefs$OutcomeFactor == "Died", "TimeSinceSubmission"], na.rm=T)
IQR(coefs[coefs$OutcomeFactor == "Survived", "TimeSinceSubmission"], na.rm=T)
```

```{r}
albumin_time_series_plot <- draw_albumin_time_series_plot(df_all, aDeath, bDeath, aSurvived, bSurvived)
save_plot(albumin_time_series_plot + theme(legend.position = "none"), "albumin_time_series_plot")
albumin_time_series_plot
```

```{r}
cor.test(d[d$OutcomeFactor == "Died", ]$TimeSinceSubmission, d[d$OutcomeFactor == "Died", ]$albumin, 
         method = c("pearson"))
cor.test(d[d$OutcomeFactor == "Survived", ]$TimeSinceSubmission, d[d$OutcomeFactor == "Survived", ]$albumin, 
         method = c("pearson"))
```

# Glucose levels 

## Distributions and normality tests

## Gender

## Time series and trends

# Relation between albumin and glucose levels

```{r}
draw_albumin_glucose_plot <-function(df) {
  p <- ggplot(df, aes(x=glucose, y=albumin, color=OutcomeFactor, fill=OutcomeFactor)) + 
  geom_hline(aes(yintercept=35), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_hline(aes(yintercept=55), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_vline(aes(xintercept=4.0), colour=NORMAL_RANGE_COLOR, linetype="dashed") + 
  geom_vline(aes(xintercept=5.5), colour=NORMAL_RANGE_COLOR, linetype="dashed") + 
  geom_vline(aes(xintercept=11.1), colour=NORMAL_RANGE_COLOR, linetype="dashed") + 
  geom_point() + 
  theme_classic() + 
  theme(legend.position = c(0.85, 0.88), 
        text = element_text(size=FONT_SIZE), 
        axis.text.y = element_blank(),
        axis.text = element_text(colour = "black", size=FONT_SIZE)) + 
  xlab("Patient's glucose level (mmol/L)") + 
  ylab("") +
  labs(color = "Outcome", fill = "Outcome") + 
  ylim(13, 56) +
  scale_color_manual(values=OUTCOME_PALETTE) +
    scale_fill_manual(values=OUTCOME_PALETTE)
  
  p
}

albumin_glucose_plot <- draw_albumin_glucose_plot(df_last)
albumin_glucose_plot
save_plot(albumin_glucose_plot + theme(legend.position="none"), "albumin_glucose_plot", width=PLOT_SIZE*2, height = PLOT_SIZE)
```

# Relation between albumin and glucose levels

```{r}
draw_albumin_age_plot <-function(df) {
  p <- ggplot(df, aes(x=age, y=albumin, color=OutcomeFactor)) + 
  geom_hline(aes(yintercept=35), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_hline(aes(yintercept=55), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_point() + 
  theme_classic() + 
  theme(legend.position = "none", 
        text = element_text(size=FONT_SIZE), 
        axis.text = element_text(colour = "black", size=FONT_SIZE),
        axis.title.y = element_text(margin = margin(t = 0, r = 8, b = 0, l = 0))) + 
  xlab("Patient's age") + 
  ylab ("Patient's albumin level (g/L)") +
  labs(color = "Outcome") + 
  ylim(13, 56) +
  scale_color_manual(values=OUTCOME_PALETTE)
  
  p
}

albumin_age_plot <- draw_albumin_age_plot(df_last)
albumin_age_plot + ylab("Patient's albumin level (g/L)")
save_plot(albumin_age_plot + theme(legend.position="none"), "albumin_age_plot")
```

# Regression analysis

```{r}
draw_glucose_sina_plot <-function(df, plot_name) {
  p <- ggplot(df, aes(x=OutcomeFactor, y=glucose, color=OutcomeFactor)) + 
  geom_hline(aes(yintercept=7.8), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_hline(aes(yintercept=11.1), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
    
  geom_sina(seed=21) + 
  stat_summary(fun.data = "mean_sdl",  fun.args = list(mult = 1), 
               geom = "pointrange", color = "black") +
  facet_grid(cols = vars(gender)) +
  theme_classic() + 
  theme(legend.position = "none", 
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        text = element_text(size=FONT_SIZE), 
        axis.text = element_text(colour = "black", size=FONT_SIZE), 
        axis.title.y = element_text(margin = margin(t = 0, r = 8, b = 0, l = 0))) + 
  xlab("") + 
  ylab ("Patient's glucose level (mmol/L)") +
  labs(color = "Outcome") + 
  scale_color_manual(values=OUTCOME_PALETTE)
  
  save_plot(p, plot_name)
  p
}


draw_glucose_time_series_plot <- function(plot_name, aDeath, bDeath, aSurvived, bSurvived) {
  p <- ggplot(df_all, aes(x=TimeSinceSubmission, y=glucose, color=OutcomeFactor)) + 
    geom_hline(aes(yintercept=11.1), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
    geom_line(mapping=aes(group=PATIENT_ID), alpha=0.35) +
    geom_segment(aes(x=0, xend=22, y=bDeath + aDeath, 
                     yend = bDeath + aDeath*22), 
                 color=DEATH_COLOR, size=1.25) +
    geom_segment(aes(x=0, xend=22, y=bSurvived + aSurvived, 
                     yend = bSurvived + aSurvived*22),
                 color=SURVIVED_COLOR, size=1.25) +
    theme_classic() + 
    theme(legend.position = "none", 
          text = element_text(size=FONT_SIZE), 
          axis.text = element_text(colour = "black", size=FONT_SIZE), 
          axis.text.y = element_blank()) +
    xlab("Days since admission") + 
    ylab ("") +
    labs(color = "Outcome") + 
    ylim(13, 56) +
    scale_color_manual(values=OUTCOME_PALETTE)
  
  save_plot(p, plot_name)
  p
}
```

```{r}
run_logistic_regression <- function(df, formula) {
  logistic.fit<-glm(formula, family="binomial", data=df)
  print(summary(logistic.fit))
  print(exp(logistic.fit$coefficients))
  print(exp(confint(logistic.fit)))
}
```
```{r}
run_logistic_regression(df_last, OutcomeNumber~albumin)
run_logistic_regression(df_last, OutcomeNumber~gender)
run_logistic_regression(df_last, OutcomeNumber~age)
run_logistic_regression(df_last, OutcomeNumber~glucose)
```

```{r}
run_logistic_regression(df_last, OutcomeNumber~albumin + glucose + age + gender)
```

```{r}
run_logistic_regression(df_last, OutcomeNumber~albumin*gender)
run_logistic_regression(df_last, OutcomeNumber~albumin*age)
run_logistic_regression(df_last, OutcomeNumber~albumin*glucose)
```

```{r}
gender_albumin_regression <- ggplot(df_last, aes(x=albumin, y=OutcomeNumber, color=gender)) + 
  geom_point() + 
  geom_vline(aes(xintercept=35), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  geom_vline(aes(xintercept=55), colour=NORMAL_RANGE_COLOR, linetype="dashed") +
  theme_classic() + 
  theme(legend.position = c(0.15, 0.13),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        text = element_text(size=FONT_SIZE), 
        axis.text = element_text(colour = "black", size=FONT_SIZE), 
        axis.text.y = element_blank()) + 
  ylab("Probability of death") + 
  xlab ("") +
  xlim(13, 56) +
  labs(color = "Gender") + 
  scale_color_manual(values=c("#44AA99", "#AA4499")) +
  stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE) +
  coord_flip()
save_plot(gender_albumin_regression, "gender_albumin_regression")
gender_albumin_regression
```

# Citing